{{ define "helpers.js" }}
    <script type="text/javascript">
    function swapWeapon(id, action) {
        var panel = document.getElementById(id);
        if (panel == undefined) {
            console.log('Unknow panel id:', id);
            return;
        }
        var klasses1 = panel.getElementsByClassName('swap1');
        if (klasses1 == undefined) {
            console.log("Can't get classes: swap1");
            return;
        }
        var klasses2 = panel.getElementsByClassName('swap2');
        if (klasses2 == undefined) {
            console.log("Can't get classes: swap2");
            return;
        }

        switch (action) {
            case 1:
                for (var i = 0; i < klasses1.length; i++) {
                    klasses1[i].style.display="none";
                }
                for (var i = 0; i < klasses2.length; i++) {
                    klasses2[i].style.display="block";
                }
                break;
            case 2:
                for (var i = 0; i < klasses2.length; i++) {
                    klasses2[i].style.display="none";
                }
                for (var i = 0; i < klasses1.length; i++) {
                    klasses1[i].style.display="block";
                }
                break;
            default:
                console.log('unknow action:', action);
                return;
        }
    }

    var noSupport = "Your browser doesn't support local storage :'(";

    function setPriceNote(id, price) {
        if (typeof(Storage) !== "undefined") {
            if (price == "") {
                localStorage.removeItem(id);
            } else {
                localStorage.setItem(id, price);
            }
        } else {
            console.log(noSupport);
            alert(noSupport);
        }
    }

    function getPriceNote(id) {
        if (typeof(Storage) !== "undefined") {
            var price = localStorage.getItem(id);
            if (price == undefined) {
                return ""
            }
            return price;
        } else {
            console.log(noSupport);
        }
        return "";
    }

    function generateToolTipContent(id) {
        var domTooltip = document.getElementById('item-' + id + '-tooltip');
        if (domTooltip != undefined) {
            var items = domTooltip.getElementsByClassName('customPriceContainer');
            if (items.length > 0 && items[0] != undefined) {
                var item = items[0];
                var priceNote = getPriceNote('item-' + id);
                var prices = item.getElementsByClassName('customPrice');
                if (prices.length > 0 && prices[0] != undefined) {
                    var price = prices[0];
                    price.innerHTML = priceNote;
                    if (priceNote != "") {
                            item.style.display = 'block';
                    } else {
                        // Price has been removed
                        item.style.display = 'none';
                    }
                }
            }
            return domTooltip.innerHTML;
        }
        return "";
    }

    function updateToolTipContent(elt, id) {
        elt.setContent(generateToolTipContent(id));
    }

    // Update currency image
    function updateCurrencyThumbnail(id) {
        var thumbnail = document.getElementById(id + '-currency');
        if (thumbnail == undefined) {
            // Socketed gems have no thumbnail
            return;
        }
        var imgThumbnail = document.getElementById(id + '-currency-img');
        var txtThumbnail = document.getElementById(id + '-currency-span');
        var priceNote = getPriceNote(id);
        if (priceNote == "") {
            thumbnail.style.display = 'none';
        } else {
            thumbnail.style.display = 'block';
            var words = priceNote.split(' ');
            switch (words[2]) {
                case "chaos":
                    imgThumbnail.src = 'https://web.poecdn.com/image/Art/2DItems/Currency/CurrencyRerollRare.png?scale=1&w=1&h=1&v=c60aa876dd6bab31174df91b1da1b4f9'
                    break;
                case "alch":
                    imgThumbnail.src = 'https://web.poecdn.com/image/Art/2DItems/Currency/CurrencyUpgradeToRare.png?scale=1&w=1&h=1&v=89c110be97333995522c7b2c29cae728'
                    break;
                case "exa":
                    imgThumbnail.src = 'https://web.poecdn.com/image/Art/2DItems/Currency/CurrencyAddModToRare.png?scale=1&w=1&h=1&v=1745ebafbd533b6f91bccf588ab5efc5'
                    break;
            }
            txtThumbnail.innerHTML = 'x' + words[1];
        }
    }

    function openWindowWithPost(text) {
        console.log(text);
        var f = document.getElementById('estimate-form');
        console.log(f);
        f.itemtext.value = text;
        console.log(f);
        window.open('', 'estimation');
        f.submit();
    }

    function openModal(id, objectName, objectAltName, desc) {
        var modal = document.getElementById('modal');
        var container = document.getElementById('main-container');
        var name = document.getElementById('item-name');
        var estimate = document.getElementById('modal-estimate');
        var submit = document.getElementById('modal-submit');
        var modalPrice = document.getElementById('modal-price');
        var currentPrice = getPriceNote(id);
        if (currentPrice != "") {
            var words = currentPrice.split(' ');
            modalPrice.value = words[1];
        }

        var header =  "";
        if (objectName != "") {
           header = objectName + " - ";
        }
        if (objectAltName != "") {
            header += objectAltName;
        }
        name.innerHTML = header;
        modal.className = "modal";
        container.className = "desactivate";
        submit.onclick = function(event) {
            modal.className = "modal hidden";
            container.className = "";
            var modalCurrency = document.getElementById('modal-currency');
            var currency = modalCurrency.options[modalCurrency.selectedIndex];
            var note = "~price " + modalPrice.value + " " + currency.value;
            if (modalPrice.value == "") {
                setPriceNote(id, "");
            } else {
                setPriceNote(id, note);
            }
            updateCurrencyThumbnail(id);
        }
        estimate.onclick = function(event) {
            var item = document.getElementById(id);
            if (item != undefined) {
                var desc = item.getAttribute("data-desc");
                if (desc != undefined) {
                    openWindowWithPost(desc)
                }
            }
        }
    }

    function openWaitModal() {
        var modal = document.getElementById('wait-modal');
        var container = document.getElementById('main-container');
        modal.className = "modal";
        container.className = "desactivate";
    }


    function initModal() {
        var modal = document.getElementById('modal');
        var close = document.getElementById('closeModal');
        var container = document.getElementById('main-container');

        if (modal == undefined || close == undefined || container == undefined) {
            return;
        }

        // Click on close button
        close.onclick = function(event) {
            modal.className = "modal hidden";
            container.className = "";
        }
        // Click outside of the modal
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.className = "modal hidden";
                container.className = "";
            }
        }
    }

    function copyStringToClipboard(str) {
        var el = document.createElement('textarea');
        el.value = str;
        // Set non-editable to avoid focus and move outside of view
        el.setAttribute('readonly', '');
        el.style = {position: 'absolute', left: '-9999px'};
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);
    }

    function toInt(str) {
        var parsed = parseInt(str, 10);
        if (isNaN(parsed)) {
            return 0;
        }
        return parsed;
    }

    // Receive a desc like "~price <value> >currency>"
    // and extract the value.
    function valueFromDesc(desc) {
        var res = 0;
        var words = desc.split(' ');
        switch (words[2]) {
            case "chaos":
                res = 10000;
                break;
            case "alch":
                res = 1000;
                break;
            case "exa":
                res = 100000;
                break;
        }

        return res + toInt(words[1]);
    }

    function generateShop() {
        var dict = {};
        var items = document.getElementsByClassName('newItemContainer');
        // Retrieve all sellable objects
        for (var i = 0; i < items.length; i++) {
            var desc = items[i].getAttribute("data-sell");
            if (desc != undefined) {
                var price = getPriceNote(items[i].id);
                if (price != "") {
                    var value = valueFromDesc(price);
                    console.log(desc, value);
                    if (dict[value] == undefined) {
                        dict[value] = [];
                    }
                    dict[value].push({'desc': desc, 'price': price});
                }
            }
        }

        // Construct shop list regrouped and sorted by prices
        var text = 'Welcome to my shop !\n';
        for (var value in dict) {
            var items = dict[value];
            // Here, we are guaranted to have at least one element
            // and all of them should have the same price note.
            var price = items[0].price;
            text += '[spoiler="' + price + '"]\n';
            for (var i = 0; i < items.length; i++) {
                text += items[i].desc + "\n";
            }
            text += "[/spoiler]\n";
        }
        text += "This shop has been generated with poe-stash {{ Version }}\n";
        copyStringToClipboard(text);
        openAlert();
    }

    function exportShop() {
        var data = JSON.stringify(localStorage);
        let content = "data:text/html;charset=utf-8," + data;
        var encodedUri = encodeURI(content);
        var link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "poe-shop.txt");
        document.body.appendChild(link); // Required for FF
        link.click();
        link.parentNode.removeChild(link);
    }

    function initImport() {
        var shop = document.getElementById('shop-file');
        if (shop != undefined) {
            shop.addEventListener('change', importShop, false);
        }
    }

    function importShop(evt) {
        console.log('called?', evt);

        // Check for the various File API support.
        if (!window.File || !window.FileReader || !window.FileList || !window.Blob) {
            alert('The File APIs are not fully supported in this browser. Import is not possible!');
            return;
        }

        var files = evt.target.files;
        console.log(files);
        var output = [];
        for (var i = 0, f; f = files[i]; i++) {
            console.log(f.name, f.type);
            // Only process text files.
            if (!f.type.match('text.*')) {
                continue;
            }

            var reader = new FileReader();
            // Closure to capture the file information.
            reader.onload = (function(theFile) {
                return function(e) {
                    var rawDataFile = e.target.result;
                    var data = JSON.parse(rawDataFile);
                    if (data != "") {
                        Object.keys(data).forEach(function (k) {
                            localStorage.setItem(k, data[k]);
                        });
                    }
                };
            })(f);

            reader.readAsText(f);
        }
    }

    function openAlert() {
        var confirm = document.getElementById('confirm');
        if (confirm != undefined) {
            confirm.className = 'box openAnimation';
        }
    }

    function closeAlert() {
        var confirm = document.getElementById('confirm');
        if (confirm != undefined) {
            confirm.className = 'box closeAnimation';
        }
    }

    function redirectToGen(account, poeSessid) {
        openWaitModal();
        if (poeSessid != "") {
            window.location.href = "/gen/" + account + "?poesessid=" + poeSessid;
        } else {
            window.location.href = "/gen/" + account;
        }
    }

    function formatSubmit() {
        var account = document.getElementById('account');
        if (account == undefined) {
            console.log("Can't get account!");
            return;
        }
        var poesessid = document.getElementById('poesessid');
        if (poesessid == undefined) {
            console.log("Can't get poesessid!");
            return;
        }
        redirectToGen(account.value, poesessid.value);
    }

    initImport();
    initModal();
    </script>
{{ end }}
